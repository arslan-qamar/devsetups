# -*- mode: ruby -*-
# vi: set ft=ruby :

ENV['VAGRANT_CUSTOM_KEY_PATH'] ||= '../ubuntu-autoinstall/vagrant_custom_key'
# Resolve the custom key path on the host and define a temporary path in the VM
ssh_key_tmp = "/tmp/id_ed25519"
ssh_key_pub_tmp = "/tmp/id_ed25519.pub"

ssh_key_dest = "~/.ssh/id_ed25519"
ssh_key_pub_dest = "~/.ssh/id_ed25519.pub"


# Load the base Vagrantfile
load File.expand_path("../ubuntu-autoinstall/vagrant-base/Vagrantfile.base", __dir__)

Vagrant.configure("2") do |config|
  config.vm.box = "ubuntu-dev" 

  # Copy the custom SSH key from host to a temporary location in the VM
  config.vm.provision "file", source: ssh_key_dest, destination: ssh_key_tmp  
  config.vm.provision "file", source: ssh_key_pub_dest, destination: ssh_key_pub_tmp  
  
  # Run bootstrap script on first boot
  config.vm.provision "shell", privileged: false, inline: <<-SHELL
    set -e
    echo "Downloading and running bootstrap..."
    wget --header="Cache-Control: no-cache" -qO- "https://raw.githubusercontent.com/arslan-qamar/devsetups/refs/heads/main/bootstrap.sh?ts=$(date +%s)" | bash -s "main.yml" "localhost," "local" "install" "deps,devbox,docker,githubcli,vscode,zsh,dotnet"      
    
    # Move the custom keys to ~/.ssh and set permissions
    echo "Setting up Host SSH key for git clone..."
    
    if [ ! -f "#{ssh_key_dest}" ]; then
      mv #{ssh_key_tmp} #{ssh_key_dest}
      mv #{ssh_key_pub_tmp} #{ssh_key_pub_dest}
    else
      echo "SSH key file already found at ~/.ssh/id_ed25519, skipping SSH key setup."
    fi    
    
    if [ ! -d "interactivebrokers2" ]; then
      GIT_SSH_COMMAND="ssh -o StrictHostKeyChecking=no" git clone git@github.com:arslan-qamar/interactivebrokers2.git
    fi
    
    git config --global gpg.format ssh
    git config --global user.signingkey #{ssh_key_pub_dest}
    git config --global commit.gpgsign true
    
    
  SHELL
  
  # Add VirtualBox-specific customizations
  config.vm.provider "virtualbox" do |vb|
    vb.gui = true
    vb.memory = "16384"    
  end
  
end
